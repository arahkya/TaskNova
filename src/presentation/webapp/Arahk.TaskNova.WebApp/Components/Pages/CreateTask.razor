@page "/"

@rendermode InteractiveServer
@inject MyMediatr _myMediatr

<h1>Create Task</h1>
<div class="col-4">
    <label class="form-label">Title</label>
    <div class="mb-3">
        <input name="input-title" type="text" class="form-control" @bind-value="_viewModel!.Title"
            placeholder="Enter task title" />
    </div>

    <label class="form-label">Detail</label>
    <div>
        <input name="input-detail" @bind="_viewModel!.Description" class="form-control"
            placeholder="Enter task description" />
    </div>

    <button class="btn btn-success mt-4" @onclick="HandleCreateTask">Create Task</button>
</div>

<hr />

<TaskList @ref="taskListComponent" />

@code {
    private CreateTaskViewModel? _viewModel;
    private TaskList? taskListComponent;

    protected override void OnInitialized()
    {
        _viewModel = new CreateTaskViewModel(_myMediatr);
    }

    private async Task HandleCreateTask()
    {
        if (_viewModel != null)
        {
            var success = await _viewModel.SubmitCreateTask();

            if (success && taskListComponent != null)
            {
                // Instead of manually adding the task, refresh the entire list from database
                // This ensures we get the actual data with correct IDs
                await taskListComponent.RefreshTasks();

                // Clear the form
                _viewModel.Title = string.Empty;
                _viewModel.Description = string.Empty;
            }
        }
    }
}
